<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Ayaka Book</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="intro.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="cook/summary.html"><strong aria-hidden="true">2.</strong> Start from zero</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="cook/01-install-rust.html"><strong aria-hidden="true">2.1.</strong> Install Rust</a></li><li class="chapter-item expanded "><a href="cook/02-install-makefile.html"><strong aria-hidden="true">2.2.</strong> Install Makefile</a></li></ol></li><li class="chapter-item expanded "><a href="quick_start.html"><strong aria-hidden="true">3.</strong> Start from source</a></li><li class="chapter-item expanded "><a href="config/summary.html"><strong aria-hidden="true">4.</strong> Config</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="config/structure.html"><strong aria-hidden="true">4.1.</strong> File structure</a></li><li class="chapter-item expanded "><a href="config/character.html"><strong aria-hidden="true">4.2.</strong> Specify character</a></li><li class="chapter-item expanded "><a href="config/resources.html"><strong aria-hidden="true">4.3.</strong> Resources</a></li><li class="chapter-item expanded "><a href="config/i18n.html"><strong aria-hidden="true">4.4.</strong> Internationalization</a></li><li class="chapter-item expanded "><a href="config/switches.html"><strong aria-hidden="true">4.5.</strong> Switches</a></li><li class="chapter-item expanded "><a href="config/script.html"><strong aria-hidden="true">4.6.</strong> Script</a></li></ol></li><li class="chapter-item expanded "><a href="runtime/summary.html"><strong aria-hidden="true">5.</strong> Runtime</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="runtime/run.html"><strong aria-hidden="true">5.1.</strong> Run a game</a></li></ol></li><li class="chapter-item expanded "><a href="plugin/summary.html"><strong aria-hidden="true">6.</strong> Plugin</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="plugin/script_plugin.html"><strong aria-hidden="true">6.1.</strong> Script plugin</a></li><li class="chapter-item expanded "><a href="plugin/text_plugin.html"><strong aria-hidden="true">6.2.</strong> Text plugin</a></li><li class="chapter-item expanded "><a href="plugin/line_plugin.html"><strong aria-hidden="true">6.3.</strong> Line plugin</a></li><li class="chapter-item expanded "><a href="plugin/action_plugin.html"><strong aria-hidden="true">6.4.</strong> Action plugin</a></li><li class="chapter-item expanded "><a href="plugin/game_plugin.html"><strong aria-hidden="true">6.5.</strong> Game plugin</a></li></ol></li><li class="chapter-item expanded "><a href="gui/summary.html"><strong aria-hidden="true">7.</strong> GUI</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="gui/live2d.html"><strong aria-hidden="true">7.1.</strong> Live2D</a></li></ol></li><li class="chapter-item expanded "><a href="packaging.html"><strong aria-hidden="true">8.</strong> Packaging</a></li><li class="chapter-item expanded "><a href="platforms.html"><strong aria-hidden="true">9.</strong> Support platforms</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Ayaka Book</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="introduction"><a class="header" href="#introduction">Introduction</a></h1>
<p>Ayaka project was initially a project for OSPP 2022.
It is a voice novel engine which aims at 3 goals: simple, free, concentrate.</p>
<h2 id="simple"><a class="header" href="#simple">Simple</a></h2>
<p>A visual novel should be easy to author.
The author need little knowledge of programming.
We provide a config file format based on YAML and TeX-like commands.
It is easy to learn and author your own voice novel.</p>
<h2 id="free"><a class="header" href="#free">Free</a></h2>
<p>You are free to implement anything you'd like with our plugin system.
We provide a simple, but also strong script plugin by default.
The plugin system provides possibility to calculate and hook important parts in the runtime.</p>
<h2 id="concentrate"><a class="header" href="#concentrate">Concentrate</a></h2>
<p>The project is separated into 4 parts: runtime, plugins, config, frontend.
You can concentrate at one part without knowing about others.
If you like, you can write config file only, and author a voice novel.
You can also write your own fantastic game by customizing the frontend.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="start-from-zero"><a class="header" href="#start-from-zero">Start from zero</a></h1>
<p>Here is the guide with zero knowledge of computer programming.
You will learn to install Rust and install Makefile.
Then you can follow the instructions in <a href="cook/../quick_start.html">Start from source</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="install-rust"><a class="header" href="#install-rust">Install Rust</a></h1>
<p>Rust is a modern, compiled language, which means it doesn't need a special runtime environment or an interpreter to execute. What we need to install is the development environment of Rust.</p>
<p>Browse to the <a href="https://www.rust-lang.org/">official cite</a> of Rust first. Then we download following the <a href="https://www.rust-lang.org/tools/install">installation guide</a> on the official cite.</p>
<p>Rust can run on Windows, Linux, macOS, FreeBSD and NetBSD.</p>
<h2 id="if-you-are-working-on-windows"><a class="header" href="#if-you-are-working-on-windows">If you are working on Windows</a></h2>
<p>Choose to download <a href="https://static.rust-lang.org/rustup/dist/i686-pc-windows-msvc/rustup-init.exe">32-bit</a> or <a href="https://static.rust-lang.org/rustup/dist/x86_64-pc-windows-msvc/rustup-init.exe">64-bit</a> <code>rustup</code> installer according your operating system.</p>
<h2 id="if-you-are-working-on-unix"><a class="header" href="#if-you-are-working-on-unix">If you are working on Unix</a></h2>
<p>Run the following command in the terminal</p>
<pre><code>curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
</code></pre>
<p>and follow the instructions.</p>
<p>After the installation done, type <code>rust --version</code>, <code>cargo --version</code> and <code>rustup --version</code> in the terminal to make sure the installation valid.</p>
<h2 id="switch-to-nightly"><a class="header" href="#switch-to-nightly">Switch to nightly</a></h2>
<pre><code>rustup install nightly
rustup default nightly
</code></pre>
<h2 id="notes-on-every-time-before-running"><a class="header" href="#notes-on-every-time-before-running">Notes on every time before running...</a></h2>
<p>We use nightly toolchain to compile. You need to update regularly</p>
<pre><code>rustup update
</code></pre>
<p>and</p>
<pre><code>git pull
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="install-makefile"><a class="header" href="#install-makefile">Install Makefile</a></h1>
<p>Ayaka uses Makefile to organize the compilation and testing of the components.</p>
<h2 id="if-you-are-working-on-windows-1"><a class="header" href="#if-you-are-working-on-windows-1">If you are working on Windows</a></h2>
<p>We suggest using MSYS2 distributed <a href="https://packages.msys2.org/package/make"><code>make</code></a> or MSYS2 distributed <a href="https://packages.msys2.org/base/mingw-w64-make"><code>mingw32-make</code></a>, or <a href="https://chocolatey.org/">chocolatey</a> distributed <a href="https://community.chocolatey.org/packages/make"><code>make</code></a>.</p>
<h3 id="install-msys2-distributed-one"><a class="header" href="#install-msys2-distributed-one">Install MSYS2 distributed one</a></h3>
<p>Download the installer from <a href="https://www.msys2.org/">MSYS2 official site</a> and follow the installation instructions.</p>
<p>And run the following command in the MSYS2 shell</p>
<pre><code>pacman -S make
</code></pre>
<p>to install <code>make</code>. If you would like a specific MinGW Makefile, e.g. MinGW64 one, run</p>
<pre><code>pacman -S mingw-w64-x86_64-make
</code></pre>
<p>to install <code>mingw32-make</code> in that environment.</p>
<h3 id="install-chocolatey-distributed-one"><a class="header" href="#install-chocolatey-distributed-one">Install chocolatey distributed one</a></h3>
<p>Follow the instructions on the <a href="https://chocolatey.org/install">chocolatey official site</a> to install chocolatey.</p>
<p>Run the following command</p>
<pre><code>choco install make
</code></pre>
<h3 id="add-make-to-path-environmental-variable"><a class="header" href="#add-make-to-path-environmental-variable">Add <code>make</code> to <code>PATH</code> environmental variable</a></h3>
<p>If you use MSYS2, <code>make</code> won't be add into <code>PATH</code>, and you can only use it in the MSYS2 shell. To make it easier, you can choose to add the corresponding directory of MSYS2 <code>/usr/bin</code> (or MinGW64 <code>/mingw64/bin</code>), usually <code>C:\msys64\usr\bin</code> (or <code>C:\msys64\mingw64\bin</code>) into environmental variable <code>PATH</code>.</p>
<p>You can also choose to not changing the environmental variable, but let MSYS2 shell inherit the variables from Windows, to call <code>cargo</code> and <code>npm</code> in it. According to the <a href="https://sourceforge.net/p/msys2/discussion/general/thread/dbe17030/">solution from developers</a>, you can change environmental variable <code>MSYS2_PATH_TYPE</code> to <code>inherit</code>.</p>
<h2 id="if-you-are-working-on-linux"><a class="header" href="#if-you-are-working-on-linux">If you are working on Linux</a></h2>
<p>Distros of Linux differ, but usually the package name should be <code>make</code>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="start-from-source"><a class="header" href="#start-from-source">Start from source</a></h1>
<h2 id="prerequisites"><a class="header" href="#prerequisites">Prerequisites</a></h2>
<p>All platforms need <a href="https://www.rust-lang.org/">Rust</a> and <a href="https://nodejs.org/">Nodejs</a> installed.</p>
<ul>
<li>Rust: nightly toolchain.</li>
<li>Nodejs: 14.18+/16+ required by <a href="https://vitejs.dev/">Vite</a>.</li>
</ul>
<h3 id="windows"><a class="header" href="#windows">Windows</a></h3>
<p>Windows 10+ is recommended but any Windows that Rust supports is OK.</p>
<p><a href="https://developer.microsoft.com/en-us/microsoft-edge/webview2/">WebView2</a> is required by <a href="https://tauri.app/">Tauri</a>. It comes with the latest Edge browser.</p>
<p>To run the Makefile toolchain, you need GNU Make from <a href="https://www.msys2.org/">MSYS2</a> project, either for Msys2(<code>make</code>) or Mingw64(<code>mingw32-make</code>).</p>
<p>Note that if you have a WSL <code>bash.exe</code> in PATH before MSYS2 one, the <code>npm</code> command may fail.</p>
<h3 id="linux"><a class="header" href="#linux">Linux</a></h3>
<p><code>webkit2gtk</code> is needed. We only support <code>webkit2gtk-4.0</code> required by <a href="https://tauri.app/">Tauri</a>.</p>
<h3 id="macos"><a class="header" href="#macos">macOS</a></h3>
<p>Generally we don't need anything more, but you should ensure there a <code>make</code>.</p>
<h2 id="clone-from-source"><a class="header" href="#clone-from-source">Clone from source</a></h2>
<pre><code class="language-bash">$ git clone https://github.com/Uni-Gal/Ayaka.git
$ cd Ayaka
</code></pre>
<h2 id="add-targets-for-webassembly"><a class="header" href="#add-targets-for-webassembly">Add targets for WebAssembly</a></h2>
<pre><code class="language-bash">$ rustup target add wasm32-unknown-unknown
</code></pre>
<h2 id="test-the-utilities"><a class="header" href="#test-the-utilities">Test the utilities</a></h2>
<pre><code class="language-bash">$ make test
</code></pre>
<h2 id="run-examples"><a class="header" href="#run-examples">Run examples</a></h2>
<pre><code class="language-bash">$ # Run Fibonacci2
$ make example-Fibonacci2
$ # Run Orga in GUI
$ make example-Orga-gui
</code></pre>
<h2 id="release-build-of-frontends"><a class="header" href="#release-build-of-frontends">Release build of frontends</a></h2>
<pre><code class="language-bash">$ make release
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="config"><a class="header" href="#config">Config</a></h1>
<p>Ayaka config is based on YAML. The structure is simple to author.</p>
<p>The articles below uses <code>ayaka-check</code> to show the example,
it may behave a little different in GUI.
To run the examples, you need to create a config file with full <a href="config/./structure.html">structure</a>, go to the <code>bins</code> folder and run</p>
<pre><code class="language-bash">$ cargo run --package ayaka-check -- path/to/config.yaml --auto
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="file-structure"><a class="header" href="#file-structure">File structure</a></h1>
<h2 id="directory-structure"><a class="header" href="#directory-structure">Directory structure</a></h2>
<pre><code class="language-ignore">config.yaml
├─paras
│ ├─ja
│ │ ├─start.yaml
│ │ └─end.yaml
│ └─zh-Hans
│   ├─start.yaml
│   └─end.yaml
└─res
  ├─ja.yaml
  └─zh-Hans.yaml
</code></pre>
<h2 id="properties"><a class="header" href="#properties">Properties</a></h2>
<p>The total config file is a <code>GameConfig</code> object.
Here shows the properties:</p>
<div class="table-wrapper"><table><thead><tr><th>Property</th><th>Description</th></tr></thead><tbody>
<tr><td><code>title</code></td><td>The title of the game.</td></tr>
<tr><td><code>base_lang</code></td><td>The base language.</td></tr>
<tr><td><code>paras</code></td><td>The paragraph path.</td></tr>
<tr><td><code>start</code></td><td>The start paragraph.</td></tr>
<tr><td><code>author</code></td><td>Optional. The author of the game.</td></tr>
<tr><td><code>plugins</code></td><td>Optional. The <code>PluginConfig</code> object.</td></tr>
<tr><td><code>res</code></td><td>Optional. The resource path.</td></tr>
<tr><td><code>props</code></td><td>Optional. The custom properties.</td></tr>
</tbody></table>
</div>
<p>The <code>PluginConfig</code> object contains the base directory and the plugin names:</p>
<div class="table-wrapper"><table><thead><tr><th>Property</th><th>Description</th></tr></thead><tbody>
<tr><td><code>dir</code></td><td>The directory.</td></tr>
<tr><td><code>modules</code></td><td>The plugin names.</td></tr>
</tbody></table>
</div>
<p>A <code>Paragraph</code> object is a collection of texts:</p>
<div class="table-wrapper"><table><thead><tr><th>Property</th><th>Description</th></tr></thead><tbody>
<tr><td><code>tag</code></td><td>The tag and key of the paragraph.</td></tr>
<tr><td><code>texts</code></td><td>The texts.</td></tr>
<tr><td><code>title</code></td><td>Optional. The title of the paragraph.</td></tr>
<tr><td><code>next</code></td><td>Optional. The next paragraph.</td></tr>
</tbody></table>
</div>
<h2 id="the-visibility-of-paragraphs"><a class="header" href="#the-visibility-of-paragraphs">The visibility of paragraphs</a></h2>
<p>Only the paragraph whose tag is the same as the file name(without extension) is public to all paragraphs.
The rest paragraphs in this file could only be referenced by the paragraphs in the same file.</p>
<p>For example, for <code>start.yaml</code></p>
<pre><code class="language-ignore">- tag: start
  next: foo
- tag: foo
  next: bar
- tag: bar
  next: end
</code></pre>
<p>and <code>end.yaml</code></p>
<pre><code class="language-ignore">- tag: end
  next: foo
- tag: foo
  next: bar
- tag: bar
</code></pre>
<p>The <code>foo</code> and <code>bar</code> referenced are the ones in the same file, while <code>start</code> and <code>end</code> could be referenced from other files.</p>
<h2 id="basic-example"><a class="header" href="#basic-example">Basic example</a></h2>
<p>This is a config example, with 2 paragraphs.</p>
<pre><code class="language-ignore">config.yaml
└─paras
  └─en
    ├─para1.yaml
    └─para2.yaml
</code></pre>
<p><code>config.yaml</code></p>
<pre><code class="language-yaml">title: Title
base_lang: en
paras: paras
start: para1
</code></pre>
<p><code>para1.yaml</code></p>
<pre><code class="language-yaml">- tag: para1
  texts:
    - This is the first line.
    - This is the second line.
  next: para2
</code></pre>
<p><code>para2.yaml</code></p>
<pre><code class="language-yaml">- tag: para2
  texts:
    - The first line of the second paragraph.
</code></pre>
<p>The output will be</p>
<pre><code class="language-ignore">This is the first line.
This is the second line.
The first line of the second paragraph.
</code></pre>
<p>You can see that the game starts at the first paragraph <code>para1</code>,
and it jumps to <code>para2</code> after <code>para1</code> ends.
The game exits after <code>para2</code> ends, because it doesn't specify the next paragraph.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="specify-character"><a class="header" href="#specify-character">Specify character</a></h1>
<p>The dialogues should be marked with the speaking character.
We specify a character with <code>///</code> prefix.</p>
<h2 id="add-the-character-names"><a class="header" href="#add-the-character-names">Add the character names</a></h2>
<p>The character names should be placed in <code>res</code> at the front of the game.
Not only because the character name is too long to type again and again, but also to make i18n easy.</p>
<p>The key of the character name should be prefixed with <code>ch_</code>:</p>
<pre><code class="language-yaml">ch_foo: A. Foo
ch_bar: B. Bar
</code></pre>
<p>You can then specify the character with the command:</p>
<pre><code class="language-yaml">- /foo//This is the first line.
- /bar//This is the second line.
</code></pre>
<p>These two lines will output as:</p>
<pre><code class="language-ignore">_A. Foo_This is the first line.
_B. Bar_This is the second line.
</code></pre>
<p>Note the double slashes in <code>/foo//</code> could not be simplified.</p>
<h2 id="specify-the-alias-of-the-character"><a class="header" href="#specify-the-alias-of-the-character">Specify the alias of the character</a></h2>
<p>Sometimes we need a temporary alias of the current character:</p>
<pre><code class="language-yaml">- /foo/Person 1st/This is the first line.
- /bar/Person 2nd/This is the second line.
</code></pre>
<p>The output will be</p>
<pre><code class="language-ignore">_Person 1st_This is the first line.
_Person 2nd_This is the second line.
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="resources"><a class="header" href="#resources">Resources</a></h1>
<p>The resources are indexed by locale:</p>
<pre><code class="language-ignore">config.yaml
└─res
  ├─en.yaml
  ├─ja.yaml
  └─zh.yaml
</code></pre>
<p>You can specify other locales, too.
The keys not specified in other locales will fallback to <code>base_lang</code> ones.</p>
<p><code>en.yaml</code></p>
<pre><code class="language-yaml">foo: Foo
bar: Bar
</code></pre>
<p><code>zh.yaml</code></p>
<pre><code class="language-yaml">foo: 天
bar: 地
</code></pre>
<h2 id="reference-resources"><a class="header" href="#reference-resources">Reference resources</a></h2>
<p>You can reference resources in texts with <code>\res{}</code> command.</p>
<pre><code class="language-yaml">- The foo value is \res{foo}
- The bar value is \res{bar}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="internationalization"><a class="header" href="#internationalization">Internationalization</a></h1>
<h2 id="icu"><a class="header" href="#icu">ICU</a></h2>
<p>The i18n feature are supported by <a href="https://github.com/unicode-org/icu4x">ICU4X</a> with <a href="https://github.com/unicode-org/cldr">CLDR</a> data.
We use CLDR to choose the best fit locale for current system.</p>
<h2 id="simplify-translation"><a class="header" href="#simplify-translation">Simplify translation</a></h2>
<p>The translation of the texts is always a difficult job. You don't need to copy all commands as is.
For example, the original text (<code>ja</code>)</p>
<pre><code class="language-ignore">- bg: 0
- /rd//団長！車の用意できました！
- switches:
  - おう！
  - 止まるんじゃねぇぞ！
  - 止まれ！
</code></pre>
<p>could be translated as (<code>zh-Hans</code>)</p>
<pre><code class="language-ignore">-
- 团长！车已经准备好了！
- switches:
  - 哦！
  - 不要停下来啊！
  - 停下！
</code></pre>
<h2 id="fallback"><a class="header" href="#fallback">Fallback</a></h2>
<p>The resources, commands, and even paragraphs could be fell back, if a translated one is not apparent.
However, some other ones couldn't be fell back.</p>
<h3 id="fallback-with-empty-text"><a class="header" href="#fallback-with-empty-text">Fallback with empty text</a></h3>
<p>If a certain translated line is empty, it will fall back to the base language one.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="switches"><a class="header" href="#switches">Switches</a></h1>
<p>The switches could be specified with <code>switches</code> command.</p>
<p>Some special global variables are used.
<code>$?</code> is the index of selected switch (start from 0).
<code>$&lt;num&gt;</code> indicates whether a switch is enabled, and is cleared after one switch is selected.
If a specific <code>$&lt;num&gt;</code> variable is not defined or defined as <code>null</code> or <code>~</code>, it is treated as <code>true</code>.</p>
<pre><code class="language-yaml">- 'Choose a switch:'
- exec: $3 = false
- switches:
  - Switch 1
  - Switch 2
  - Not enabled
- You chose switch \var{?}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="script"><a class="header" href="#script">Script</a></h1>
<p>Ayaka script is dynamic typed.
The only supported types are unit <code>~</code>, boolean, integer, and string.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub enum RawValue {
    Unit,
    Bool(bool),
    Num(i64),
    Str(String),
}
<span class="boring">}</span></code></pre></pre>
<h2 id="using-ayacript"><a class="header" href="#using-ayacript">Using <code>ayacript</code></a></h2>
<p><code>ayacript</code> is the plugin that provides Ayaka script functionalities.
You need to add <code>ayascript</code> to the config file. See <a href="config/../plugin/summary.html">Plugin</a>.</p>
<h2 id="execute-scripts"><a class="header" href="#execute-scripts">Execute scripts</a></h2>
<p>Execute a piece of script(we call it <em>program</em>) with <code>exec</code> command:</p>
<pre><code class="language-yaml">- exec: $res = 1 + 1
- 1 + 1 = \var{res}
</code></pre>
<p>The output is</p>
<pre><code class="language-ignore">1 + 1 = 2
</code></pre>
<p>The script <code>$res = 1 + 1</code> is evaluated, and the result is <code>2</code>.
It is then converted to string and appended to the text.</p>
<h2 id="example-fibonacci"><a class="header" href="#example-fibonacci">Example: Fibonacci</a></h2>
<p>With the config file, we can even calculate some math problems. For example, Fibonacci:</p>
<pre><code class="language-yaml">- tag: init
  texts:
    - '1'
    - exec: $n = 50; $a = 1; $b = 1; $i = 1;
    - \var{b}
  next: loop
- tag: loop
  texts:
    - exec: c = $b; $b += $a; $a = c; $i += 1;
    - \var{b}
    - exec: $next = if($i &lt; $n, &quot;loop&quot;)
  next: \var{next}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="runtime"><a class="header" href="#runtime">Runtime</a></h1>
<p>The runtime, aka &quot;backend&quot;, is the engine of a game.
It provides functionality to load config, settings, plugins, and control the full status.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="run-a-game"><a class="header" href="#run-a-game">Run a game</a></h1>
<p>The CLI tool in <code>bins/ayaka-check</code> is a full example to run a game.</p>
<h2 id="open-a-config-file"><a class="header" href="#open-a-config-file">Open a config file</a></h2>
<pre><code class="language-rust ignore">use ayaka_runtime::*;
let mut context = Context::open(&quot;../../../examples/Fibonacci/config.yaml&quot;, FrontendType::Text).await?;</code></pre>
<p>The context object should be initialized first to start from an initial record.</p>
<pre><code class="language-rust ignore">context.init_new();</code></pre>
<p>Then you can iterate the actions:</p>
<pre><code class="language-rust ignore">while let Some(action) = context.next_run() {
    //...
}</code></pre>
<h2 id="get-the-open-status"><a class="header" href="#get-the-open-status">Get the open status</a></h2>
<p>The <code>context</code> also implements <code>Stream</code>.
The <code>OpenStatus</code> could be iterated before the future awaited.</p>
<pre><code class="language-rust ignore">use ayaka_runtime::*;
let context = Context::open(&quot;../../../examples/Fibonacci/config.yaml&quot;, FrontendType::Text);
let mut context = std::pin::pin!(context);
while let Some(status) = context.next().await {
    println!(&quot;{:?}&quot;, status);
}
let mut context = context.await?;</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="plugin"><a class="header" href="#plugin">Plugin</a></h1>
<p>All plugins should target WebAssembly.
We now support <code>wasm32-unknown-unknown</code> target.</p>
<p>The plugin runtime is supported by <a href="https://wasmer.io/">Wasmer</a>.
Our <a href="plugin/../platforms.html">platform support</a> is largely limited by this engine.</p>
<p>We provide a crate <code>ayaka-bindings</code> to easily author a plugin in Rust.</p>
<h2 id="load-plugins"><a class="header" href="#load-plugins">Load plugins</a></h2>
<p>Specify the plugin directory in the config file:</p>
<pre><code class="language-yaml">plugins:
  dir: path/to/plugins
</code></pre>
<p>The runtime will try to load all WebAssembly file in the directory.
If you want to specify some of them, or specify the load order, specify them in <code>modules</code>:</p>
<pre><code class="language-yaml">plugins:
  dir: path/to/plugins
  modules:
    - foo
    - bar
</code></pre>
<p>You don't need to specify the extension.</p>
<h2 id="wasm-directory-mappings"><a class="header" href="#wasm-directory-mappings">WASM directory mappings</a></h2>
<p>The parent directory of the config file (aka. the root directory) is mapped to <code>/</code> in the plugins.
Some plugins, e.g. media, need to determine if the resource files exist.
Therefore, the files should be placed under the root directory.
Symbolic links may not work if they point to directories outside the root directory.</p>
<h2 id="the-text-processing-workflow"><a class="header" href="#the-text-processing-workflow">The text processing workflow</a></h2>
<pre><code class="language-dot process">digraph {
  ori[label=&quot;Raw text&quot;];
  lines[label=&quot;Structural lines&quot;];
  exec[label=&quot;Run scripts&quot;];
  cmd[label=&quot;Custom commands&quot;];
  texts[label=&quot;Final texts&quot;];
  history[label=&quot;Record history&quot;];
  output[label=&quot;Output&quot;];

  ori -&gt; lines [label=&quot;TextParser&quot;];
  lines -&gt; exec [label=&quot;ProgramParser&quot;];
  exec -&gt; cmd [label=&quot;text plugins&quot;];
  cmd -&gt; texts [label=&quot;action plugins&quot;];
  texts -&gt; history;
  history -&gt; output;
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="script-plugin"><a class="header" href="#script-plugin">Script plugin</a></h1>
<p>All plugins are script plugins.
<a href="plugin/../config/script.html">Scripts</a> could call methods in the script plugins.</p>
<h2 id="calling-methods"><a class="header" href="#calling-methods">Calling methods</a></h2>
<p>A plugin method is referenced with <code>&lt;module&gt;.&lt;fn&gt;(...)</code> grammar.
If you would like to call the <code>rnd</code> function in <code>random</code> module,</p>
<pre><code class="language-yaml">- exec: $i = random.rnd()
</code></pre>
<p>Pass the parameters in the brace <code>()</code>.</p>
<p>As the scripts are calculated at runtime, if there's no plugin called <code>random</code>,
or no method called <code>rnd</code> inside <code>random</code>, it will give a warning, and continue with <code>RawValue::Unit</code>.</p>
<h2 id="author-a-script-plugin"><a class="header" href="#author-a-script-plugin">Author a script plugin</a></h2>
<p>Here we're going to author a script plugin <code>meet</code> to return a string &quot;Hello&quot;.</p>
<pre><code class="language-rust ignore">use ayaka_bindings::*;

#[export]
fn plugin_type() -&gt; PluginType {
    PluginType::default()
}

#[export]
fn hello(_args: Vec&lt;RawValue&gt;) -&gt; RawValue {
    RawValue::Str(&quot;Hello&quot;.to_string())
}</code></pre>
<p>And call the function:</p>
<pre><code class="language-yaml">- exec: $hello = meet.hello()
- \var{hello} from plugin!
</code></pre>
<p>If it builds successfully, and you set the right path to the plugins, it will output:</p>
<pre><code class="language-ignore">Hello from plugin!
</code></pre>
<h2 id="existing-plugins"><a class="header" href="#existing-plugins">Existing plugins</a></h2>
<p>There are some existing script (only) plugins:</p>
<div class="table-wrapper"><table><thead><tr><th>Plugin</th><th>Description</th></tr></thead><tbody>
<tr><td><code>ayalog</code></td><td>Log to runtime.</td></tr>
<tr><td><code>random</code></td><td>Generate random numbers.</td></tr>
</tbody></table>
</div><div style="break-before: page; page-break-before: always;"></div><h1 id="text-plugin"><a class="header" href="#text-plugin">Text plugin</a></h1>
<p>Text plugins deal with custom TeX-like commands.</p>
<h2 id="register-commands"><a class="header" href="#register-commands">Register commands</a></h2>
<p>Here we will register a command <code>\hello</code> and call it in the config file.
You also need <code>plugin_type</code> to specify that it is a text plugin.</p>
<pre><code class="language-rust ignore">use ayaka_bindings::*;

#[export]
fn plugin_type() -&gt; PluginType {
    PluginType::builder().text([&quot;hello&quot;]).build()
}

#[export]
fn hello(_args: Vec&lt;String&gt;, _ctx: TextProcessContext) -&gt; TextProcessResult {
    let mut res = TextProcessResult::default();
    res.line.push_back_chars(&quot;Hello&quot;);
    res
}</code></pre>
<p>Call the command in the config file:</p>
<pre><code class="language-yaml">- \hello world!
</code></pre>
<p>And it outputs:</p>
<pre><code class="language-ignore">Hello world!
</code></pre>
<h2 id="the-process-results"><a class="header" href="#the-process-results">The process results</a></h2>
<p>The <code>TextProcessResult</code> object is some lines and properties to be added to the current action. <code>line</code> will be appended to the current position of the command, and <code>props</code> will be set and update.</p>
<h2 id="existing-plugins-1"><a class="header" href="#existing-plugins-1">Existing plugins</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Plugin</th><th>Description</th></tr></thead><tbody>
<tr><td><code>basictex</code></td><td>Basic TeX commands.</td></tr>
<tr><td><code>live2d</code></td><td>Live2D commands.</td></tr>
</tbody></table>
</div><div style="break-before: page; page-break-before: always;"></div><h1 id="line-plugin"><a class="header" href="#line-plugin">Line plugin</a></h1>
<p>Line plugins provides custom line types.</p>
<h2 id="register-commands-1"><a class="header" href="#register-commands-1">Register commands</a></h2>
<p>Here we will register a command <code>\hello</code> and call it in the config file.
You also need <code>plugin_type</code> to specify that it is a line plugin.</p>
<pre><code class="language-rust ignore">use ayaka_bindings::*;

#[export]
fn plugin_type() -&gt; PluginType {
    PluginType::builder().line([&quot;hello&quot;]).build()
}

#[export]
fn hello(_ctx: LineProcessContext) -&gt; LineProcessResult {
    let mut res = LineProcessResult::default();
    res.locals.insert(&quot;hello&quot;.to_string(), RawValue::Str(&quot;Hello&quot;.to_string()));
    res
}</code></pre>
<p>Call the command in the config file:</p>
<pre><code class="language-yaml">- hello:
- \var{hello} world!
</code></pre>
<p>And it outputs:</p>
<pre><code class="language-ignore">Hello world!
</code></pre>
<h2 id="the-process-results-1"><a class="header" href="#the-process-results-1">The process results</a></h2>
<p>The <code>LineProcessResult</code> object contains the global variables and temp variables. The temp variables will only apply to this specific line.</p>
<h2 id="existing-plugins-2"><a class="header" href="#existing-plugins-2">Existing plugins</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Plugin</th><th>Description</th></tr></thead><tbody>
<tr><td><code>ayacript</code></td><td>Ayaka script.</td></tr>
<tr><td><code>media</code></td><td>Multimedia commands.</td></tr>
</tbody></table>
</div><div style="break-before: page; page-break-before: always;"></div><h1 id="action-plugin"><a class="header" href="#action-plugin">Action plugin</a></h1>
<p>Action plugins deal with the whole action after the text being parsed.
An action plugin usually modifies the text, for example, parses the Markdown text and output to HTML.</p>
<p>Action plugins could access the last action in the history, will text plugins cannot.</p>
<h2 id="simple-markdown-plugin"><a class="header" href="#simple-markdown-plugin">Simple Markdown plugin</a></h2>
<p>Action plugins don't need to register anything, but only to specify in the <code>plugin_type</code>:</p>
<pre><code class="language-rust ignore">use ayaka_bindings::*;
use pulldown_cmark::*;

#[export]
fn plugin_type() -&gt; PluginType {
    PluginType::builder().action().build()
}

#[export]
fn process_action(mut ctx: ActionProcessContext) -&gt; ActionProcessResult {
    let line = ctx
        .action
        .line
        .into_iter()
        .map(|s| s.into_string())
        .collect::&lt;Vec&lt;_&gt;&gt;()
        .concat();
    let parser = Parser::new(&amp;line);
    let mut html_output = String::new();
    html::push_html(&amp;mut html_output, parser);
    ctx.action.clear();
    ctx.action.push_back_chars(html_output);
    ActionProcessResult { action: ctx.action }
}</code></pre>
<p>Add the plugin to the <code>modules</code> list, and all markdown text will be translated to HTML.</p>
<p>You may notice that the HTML tags are treated as <code>ActionLine::Chars</code>, which means they will be displayed one by one on GUI frontends. Our existing <code>markdown</code> plugin resolves this problem by providing a custom writer.</p>
<h2 id="existing-plugins-3"><a class="header" href="#existing-plugins-3">Existing plugins</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Plugin</th><th>Description</th></tr></thead><tbody>
<tr><td><code>live2d</code></td><td>Inherit models layout and deal with hiding.</td></tr>
<tr><td><code>markdown</code></td><td>Process Markdown texts.</td></tr>
<tr><td><code>media</code></td><td>Voice of each action.</td></tr>
</tbody></table>
</div><div style="break-before: page; page-break-before: always;"></div><h1 id="game-plugin"><a class="header" href="#game-plugin">Game plugin</a></h1>
<p>Game plugins adjust some properties of the game before any record starts.</p>
<h2 id="insert-a-global-property"><a class="header" href="#insert-a-global-property">Insert a global property</a></h2>
<pre><code class="language-rust ignore">use ayaka_bindings::*;

#[export]
fn plugin_type() -&gt; PluginType {
    PluginType::builder().game().build()
}

#[export]
fn process_game(mut ctx: GameProcessContext) -&gt; GameProcessResult {
    ctx.props.insert(&quot;hello&quot;.to_string(), &quot;Hello world!&quot;.to_string());
    GameProcessResult { props: ctx.props }
}</code></pre>
<h2 id="existing-plugins-4"><a class="header" href="#existing-plugins-4">Existing plugins</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Plugin</th><th>Description</th></tr></thead><tbody>
<tr><td><code>live2d</code></td><td>Get correct path of Live2D models.</td></tr>
<tr><td><code>media</code></td><td>Get correct path of background image at home.</td></tr>
</tbody></table>
</div><div style="break-before: page; page-break-before: always;"></div><h1 id="gui"><a class="header" href="#gui">GUI</a></h1>
<p>The <code>ayaka-gui</code> is a sample GUI frontend.
It provides basic functionalities, including control flow, multimedia, i18n and Live2D integration.</p>
<p>The frontend is based on <a href="https://tauri.app/">Tauri</a> with <a href="https://vuejs.org/">Vue</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="live2d"><a class="header" href="#live2d">Live2D</a></h1>
<p>The Live2D functionality is powered by <a href="https://github.com/guansss/pixi-live2d-display"><code>pixi-live2d-display</code></a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="packaging"><a class="header" href="#packaging">Packaging</a></h1>
<p>We support package format called <code>ayapack</code>.
Internally it is a TAR format archive, without any compression.
We load the package file with memory map to reduce allocations.</p>
<h2 id="packaging-1"><a class="header" href="#packaging-1">Packaging</a></h2>
<p><code>tar</code> executable is pre-installed on almost all platforms. There may be BSD-Tar or GNU-Tar. For a directory <code>foo</code> that contains <code>config.yaml</code>, we can simply execute</p>
<pre><code class="language-bash">$ cd foo
$ tar -cf foo.ayapack *
</code></pre>
<p>The parameter <code>c</code> means creating a package, and <code>f</code> means the following parameter is the package path.</p>
<h2 id="details"><a class="header" href="#details">Details</a></h2>
<p>The details of the parsing and loading are in the <a href="https://github.com/Berrysoft/vfs-tar"><code>vfs-tar</code></a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="supported-platforms"><a class="header" href="#supported-platforms">Supported platforms</a></h1>
<p>Ayaka is cross-platform, and the triples are supported with 3 tiers.</p>
<h2 id="tier-1"><a class="header" href="#tier-1">Tier 1</a></h2>
<p>Ensured to work well with these triples:</p>
<ul>
<li>x86_64-pc-windows-msvc</li>
<li>x86_64-unknown-linux-gnu</li>
<li>x86_64-apple-darwin</li>
</ul>
<h2 id="tier-2"><a class="header" href="#tier-2">Tier 2</a></h2>
<p>Should work well with these triples, but not tested:</p>
<ul>
<li>i686-pc-windows-msvc</li>
<li>aarch64-pc-windows-msvc</li>
<li>i686-pc-windows-gnu</li>
<li>x86_64-pc-windows-gnu</li>
<li>aarch64-unknown-linux-gnu</li>
<li>aarch64-apple-darwin</li>
</ul>
<h2 id="tier-3"><a class="header" href="#tier-3">Tier 3</a></h2>
<p>May not build or run because of dependencies:</p>
<ul>
<li>s390x-unknown-linux-gnu</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </div>
    </body>
</html>
